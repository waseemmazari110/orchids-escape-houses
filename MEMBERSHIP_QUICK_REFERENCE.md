# Membership System - Quick Reference Card

## ğŸ¯ Pricing Model (Strict Rules)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pack   â”‚   Annual     â”‚   Monthly    â”‚  Savings   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bronze  â”‚ Â£450 + VAT   â”‚ Â£40/mo + VAT â”‚  Â£30/year  â”‚
â”‚         â”‚ (Â£540 total) â”‚ (Â£576/year)  â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Silver  â”‚ Â£650 + VAT   â”‚ Â£57/mo + VAT â”‚  Â£34/year  â”‚
â”‚         â”‚ (Â£780 total) â”‚ (Â£820/year)  â”‚            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Gold    â”‚ Â£850 + VAT   â”‚ Â£75/mo + VAT â”‚  Â£50/year  â”‚
â”‚         â”‚ (Â£1,020)     â”‚ (Â£1,080/year)â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Pack Features

| Feature | Bronze | Silver | Gold |
|---------|:------:|:------:|:----:|
| Fully Optimised Listing | âœ… | âœ… | âœ… |
| Page Build & Support | âŒ | âœ… | âœ… |
| Social Media Promotion | âŒ | âœ… | âœ… |
| Themed Blog Feature | âŒ | âœ… | âœ… |
| Holiday Focus Pages | 0 | 3 | 3 |
| Homepage Features | âŒ | âŒ | âœ… |
| Specialist Page | âŒ | âŒ | âœ… |

## ğŸ”„ Property Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DRAFT  â”‚  Owner creates, no payment
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ Payment completed
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PENDING_APPROVALâ”‚  Paid, awaiting admin
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚          â”‚
â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LIVE â”‚  â”‚ REJECTED â”‚  Admin decision
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚           â”‚ Can resubmit
   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAUSED â”‚         â”‚ PENDING_APPROVALâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Resume
    â””â”€â”€â”€â”€â”
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LIVE  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚ 12 months later
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ EXPIRED â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚ Renewal payment
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PENDING_APPROVALâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ›  Common Code Snippets

### Calculate Pack Pricing

```typescript
import { calculatePackPricing } from '@/lib/membership-utils';

const pricing = calculatePackPricing(pack, 'annual');
console.log(`
  Base: Â£${pricing.basePrice}
  VAT: Â£${pricing.vatAmount}
  Total: Â£${pricing.totalPrice}
  Savings: Â£${pricing.savingsVsMonthly}
`);
```

### Check Property Features

```typescript
import { getPropertyFeatures, hasFeature } from '@/lib/membership-utils';

const features = getPropertyFeatures(packFeatures, propertyStatus);

if (hasFeature(features, 'hasHomepageFeature')) {
  // Show homepage featuring option
}
```

### Validate Status Transition

```typescript
import { canTransitionTo } from '@/lib/membership-utils';

if (canTransitionTo(currentStatus, 'live')) {
  // Allow transition
} else {
  // Block transition
}
```

### Calculate Expiry

```typescript
import { daysUntilExpiry, isExpiringSoon } from '@/lib/membership-utils';

const endDate = new Date(subscription.endDate);
const days = daysUntilExpiry(endDate);

if (isExpiringSoon(endDate, 30)) {
  // Show renewal prompt
}
```

## ğŸ“¡ API Endpoints Reference

### Public/Owner

```
GET  /api/membership-packs
     â†’ Returns all packs with pricing

POST /api/properties/create
     Body: { title, location, ..., membershipPackId, paymentFrequency }
     â†’ Creates draft property

POST /api/properties/checkout
     Body: { propertyIds: [1, 2, 3] }
     â†’ Creates Stripe checkout session
```

### Admin

```
POST /api/admin/properties/approve
     Body: { propertyId }
     â†’ Approves property, sets to live

POST /api/admin/properties/reject
     Body: { propertyId, reason }
     â†’ Rejects property with reason
```

## ğŸ—„ Database Queries

### Get All Pending Properties

```typescript
const pending = await db
  .select()
  .from(properties)
  .where(
    and(
      eq(properties.status, 'pending_approval'),
      eq(properties.paymentStatus, 'paid')
    )
  );
```

### Get Owner's Properties

```typescript
const userProps = await db
  .select()
  .from(properties)
  .where(eq(properties.ownerId, userId))
  .orderBy(desc(properties.createdAt));
```

### Get Active Subscriptions

```typescript
const active = await db
  .select()
  .from(propertySubscriptions)
  .where(
    and(
      eq(propertySubscriptions.status, 'active'),
      gte(propertySubscriptions.endDate, new Date().toISOString())
    )
  );
```

### Get Expiring Soon

```typescript
const thirtyDaysLater = new Date();
thirtyDaysLater.setDate(thirtyDaysLater.getDate() + 30);

const expiring = await db
  .select()
  .from(propertySubscriptions)
  .where(
    and(
      eq(propertySubscriptions.status, 'active'),
      between(
        propertySubscriptions.endDate,
        new Date().toISOString(),
        thirtyDaysLater.toISOString()
      )
    )
  );
```

## ğŸ¨ Status Badge Colors

```typescript
const statusColors = {
  draft: 'gray',
  pending_approval: 'yellow',
  live: 'green',
  rejected: 'red',
  paused: 'blue',
  expired: 'purple',
};
```

## âš ï¸ Business Rules Validation

```typescript
// Before creating checkout
if (!property.membershipPackId) {
  throw new Error('Must select membership pack');
}

// Before approval
if (property.status !== 'pending_approval') {
  throw new Error('Can only approve pending properties');
}

if (property.paymentStatus !== 'paid') {
  throw new Error('Payment must be confirmed');
}

// Before upgrade
const packOrder = { bronze: 1, silver: 2, gold: 3 };
if (packOrder[newPack] <= packOrder[currentPack]) {
  throw new Error('Can only upgrade to higher tier');
}
```

## ğŸ“§ Email Trigger Points

```typescript
// After payment
â†’ Send to owner: "Payment received, under review"
â†’ Send to admin: "New property pending approval"

// After approval
â†’ Send to owner: "Property approved and live!"

// After rejection
â†’ Send to owner: "Property rejected: [reason]"

// 30 days before expiry
â†’ Send to owner: "Membership expiring soon"

// On expiry
â†’ Send to owner: "Membership expired, renew now"
```

## ğŸ”¢ Common Calculations

```typescript
// VAT (20%)
const withVAT = basePrice * 1.2;
const vatOnly = basePrice * 0.2;

// 12-month total (monthly)
const yearTotal = monthlyPrice * 12;

// Annual savings
const savings = (monthlyPrice * 12) - annualPrice;

// Pro-rata refund
const dailyRate = totalPaid / 365;
const refund = dailyRate * remainingDays;
```

## ğŸš¦ Permission Checks

```typescript
// Create property
role === 'owner' || role === 'admin'

// Approve property
role === 'admin'

// Edit own property
property.ownerId === userId || role === 'admin'

// View pending queue
role === 'admin'
```

---

**Print this card for quick reference during development!**
